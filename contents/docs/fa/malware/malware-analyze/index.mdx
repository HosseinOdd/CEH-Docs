---
title: آنالیز بدافزار
description: تکنیک‌های تحلیل ایستا و پویای بدافزار
---

## انواع تحلیل

### تحلیل ایستا
- بررسی بدون اجرا
- ویژگی‌های فایل، رشته‌ها، ساختار کد
- رویکرد امن‌تر
- بینش‌های محدود

### تحلیل پویا
- اجرا در محیط کنترل شده
- مشاهده رفتار و اقدامات
- جامع‌تر
- نیاز به sandbox دارد

### تحلیل ترکیبی
- ترکیب هر دو روش
- درک کامل

## تکنیک‌های تحلیل ایستا

### اطلاعات فایل
```bash
# نوع فایل
file malware.exe
# خروجی: PE32 executable (console) Intel 80386، for MS Windows

# اندازه و ویژگی‌های فایل
ls -lh malware.exe
stat malware.exe

# محاسبه هش‌ها
md5sum malware.exe
sha256sum malware.exe
```

### استخراج رشته‌ها
```bash
# استخراج رشته‌های قابل خواندن
strings malware.exe > strings.txt

# جستجو برای الگوهای خاص
strings malware.exe | grep -i "http"
strings malware.exe | grep -i "password"
strings malware.exe | grep -E "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}"

# رشته‌های یونیکد
strings -el malware.exe
```

### تحلیل PE (Windows)
```bash
# استفاده از pefile (Python)
pip install pefile

python3 << EOF
import pefile
pe = pefile.PE('malware.exe')
print(f"Entry Point: {hex(pe.OPTIONAL_HEADER.AddressOfEntryPoint)}")
print(f"Image Base: {hex(pe.OPTIONAL_HEADER.ImageBase)}")
print("Sections:")
for section in pe.sections:
    print(f"  {section.Name.decode()}: {hex(section.VirtualAddress)}")
print("Imports:")
for entry in pe.DIRECTORY_ENTRY_IMPORT:
    print(f"  {entry.dll.decode()}")
    for imp in entry.imports:
        print(f"    {imp.name.decode() if imp.name else 'N/A'}")
EOF
```

### دیس‌اسمبلی
```bash
# objdump (باینری Linux)
objdump -d malware.elf

# IDA Pro (تجاری)
# Ghidra (رایگان، ابزار NSA)
# radare2 (متن‌باز)
```

### Hex Dump
```bash
# مشاهده hex dump
hexdump -C malware.exe | less

# xxd
xxd malware.exe | less

# جستجو برای بایت‌های خاص
hexdump -C malware.exe | grep "MZ"  # هدر PE
```

## راه‌اندازی تحلیل پویا

### محیط جداسازی شده
- ماشین مجازی
- جداسازی شبکه
- قابلیت snapshot
- ابزارهای نظارت نصب شده

### پیکربندی VM
```bash
# گرفتن snapshot قبل از تحلیل
VBoxManage snapshot "Analysis_VM" take "clean_state"

# بازیابی snapshot بعد از تحلیل
VBoxManage snapshot "Analysis_VM" restore "clean_state"
```

### Fakenet/INetSim
```bash
# نصب INetSim (Linux)
sudo apt install inetsim

# شروع سرویس‌های جعلی
sudo inetsim

# پیکربندی
# /etc/inetsim/inetsim.conf
service dns
service http
service smtp
```

## تکنیک‌های تحلیل پویا

### نظارت بر پروسس
```bash
# Linux: strace
strace -f -o trace.log ./malware

# تحلیل system call
strace -c ./malware  # خلاصه

# ltrace (library calls)
ltrace ./malware

# Windows: Process Monitor (Procmon)
```

### نظارت فایل سیستم
```bash
# inotify (Linux)
inotifywait -m -r /tmp

# ممیزی فایل‌های ایجاد/تغییر یافته
auditctl -w /etc -p wa -k etc_changes
```

### تحلیل شبکه
```bash
# ضبط ترافیک
tcpdump -i any -w capture.pcap

# تحلیل Wireshark
wireshark capture.pcap

# نظارت بر اتصالات
netstat -antp
ss -tulpn

# کوئری‌های DNS
tcpdump -i any port 53
```

### نظارت رجیستری (Windows)
```powershell
# Regshot - مقایسه رجیستری قبل/بعد
# فیلترهای Process Monitor:
# Operation: RegSetValue
# Operation: RegCreateKey
```

### تحلیل حافظه
```bash
# دامپ حافظه پروسس
sudo gcore PID

# چارچوب Volatility
volatility -f memory.dump imageinfo
volatility -f memory.dump pslist
volatility -f memory.dump pstree
volatility -f memory.dump cmdline
volatility -f memory.dump netscan
volatility -f memory.dump malfind
```

## ابزارهای تحلیل خودکار

### Cuckoo Sandbox
```bash
# نصب Cuckoo
pip install -U cuckoo

# راه‌اندازی
cuckoo init

# ارسال نمونه
cuckoo submit malware.exe

# رابط وب
cuckoo web
```

### Any.run
- sandbox تعاملی آنلاین
- تحلیل لحظه‌ای
- مبتنی بر مرورگر

### Joe Sandbox
- تحلیل مبتنی بر ابر
- گزارش‌های دقیق
- پشتیبانی از OSهای متعدد

### Hybrid Analysis
- سرویس آنلاین رایگان
- تحلیل خودکار
- ارسال‌های جامعه

## جریان کار تحلیل

### 1. آمادگی
- راه‌اندازی محیط جداسازی شده
- گرفتن snapshot از VM
- آماده کردن ابزارهای نظارت
- مستندسازی baseline

### 2. تحلیل ایستا
- ویژگی‌های فایل و هش‌ها
- استخراج رشته‌ها
- تحلیل PE/ELF
- بررسی دیس‌اسمبلی

### 3. تحلیل پویا
- اجرا در sandbox
- نظارت بر عملیات فایل
- ضبط ترافیک شبکه
- ثبت تغییرات رجیستری
- تحلیل رفتار

### 4. مستندسازی
- IOC (نشانگرهای سازش)
- TTP (تاکتیک‌ها، تکنیک‌ها، رویه‌ها)
- امضاهای شبکه
- تغییرات فایل

### 5. پاکسازی
- بازیابی snapshot
- ذخیره artifacts تحلیل
- به‌روزرسانی قوانین تشخیص

## مجموعه ابزارها

### تحلیل ایستا
- **PEiD**: تشخیص packer
- **Detect It Easy (DIE)**: آنالایزر فایل
- **pestudio**: تحلیل PE
- **Ghidra**: دیس‌اسمبلر/دی‌کامپایلر
- **IDA Pro**: دیس‌اسمبلر تجاری
- **radare2**: چارچوب مهندسی معکوس

### تحلیل پویا
- **Process Monitor**: نظارت سیستم Windows
- **Process Explorer**: جایگزین task manager
- **API Monitor**: ردیابی API call
- **Wireshark**: آنالایزر شبکه
- **Regshot**: مقایسه رجیستری
- **Fakenet-NG**: شبیه‌ساز شبکه

### دیباگرها
- **x64dbg/x32dbg**: دیباگر Windows
- **OllyDbg**: دیباگر کلاسیک Windows
- **GDB**: دیباگر GNU (Linux)
- **WinDbg**: دیباگر Microsoft

### همه‌در‌یک
- **REMnux**: توزیع Linux برای تحلیل بدافزار
- **FLARE VM**: VM ویندوز برای تحلیل

## تکنیک‌های ضد تحلیل

### تشخیص
- تشخیص VM
- تشخیص دیباگر
- فرار از sandbox
- فرار مبتنی بر زمان

### مبهم‌سازی
- بسته‌بندی/رمزگذاری
- مبهم‌سازی کد
- رمزگذاری رشته
- هش‌کردن API

### مقابله با ضد تحلیل
- تغییر artifacts VM
- وصله بررسی‌های ضد اشکال‌زدایی
- استفاده از دیباگرهای مخفی
- دستکاری زمان‌بندی

## گزارش‌دهی

### عناصر کلیدی
1. **خلاصه اجرایی**
2. **جزئیات فنی**
   - اطلاعات فایل
   - تحلیل رفتار
   - فعالیت شبکه
   - مکانیزم‌های پایداری
3. **IOCها**
   - هش‌های فایل
   - آدرس‌های IP
   - نام‌های دامنه
   - کلیدهای رجیستری
   - مسیرهای فایل
4. **توصیه‌ها**
   - قوانین تشخیص
   - مراحل کاهش
   - اقدامات پیشگیری

## منابع

- کتاب تحلیل بدافزار (Michael Sikorski)
- Practical Malware Analysis
- REMnux: https://remnux.org
- FLARE VM: https://github.com/mandiant/flare-vm
- Cuckoo Sandbox: https://cuckoosandbox.org
